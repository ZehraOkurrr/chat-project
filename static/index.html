
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Room</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; max-width: 800px;}
    #log { border: 2px solid #db59ec; height: 400px; width: 100%; overflow-y: auto; padding: 8px; margin: 8px 0; }
    #log .me { font-weight: 600; color: #db59ec; }
    #log .error { color: red; font-weight: bold; }
    #log .system { color: #666; font-style: italic; }
    .row { display: flex; gap: 8px; margin: 8px 0; flex-wrap: wrap; }
    input, button { padding: 8px 10px; font-size: 14px; border-radius: 4px; border: 2px solid #db59ec; }
    input:focus, button:focus { outline: none; border-color: #a020f0; }
    button { background: #db59ec; color: white; cursor: pointer; }
    button:hover { background: #a020f0; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .h1 { color: #db59ec; text-align: center; }
    .room-info { background: #f0f0f0; padding: 8px; border-radius: 4px; margin: 8px 0; }
  </style>
</head>
<body>

  <h1 class="h1">Chat Room</h1>
  
  <div class="row">
    <input id="room" placeholder="Oda adı (örn: abc)" />
    <input id="username" placeholder="Kullanıcı adı (örn: zehra)" />
    <input id="password" type="password" placeholder="Şifre (opsiyonel)" />
    <button id="connect">Bağlan</button>
    <button id="disconnect" disabled>Çık</button>
  </div>

  <div class="room-info" id="roomInfo" style="display: none;">
    <strong>Oda Bilgisi:</strong> <span id="userCount">0</span> kişi online
  </div>

  <div id="log"></div>

  <div class="row">
    <input id="msg" placeholder="Mesaj yaz..." style="flex: 1;" disabled />
    <button id="send" disabled>Gönder</button>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const roomEl = document.getElementById('room');
    const userEl = document.getElementById('username');
    const passwordEl = document.getElementById('password');
    const msgEl = document.getElementById('msg');
    const btnConnect = document.getElementById('connect');
    const btnDisconnect = document.getElementById('disconnect');
    const btnSend = document.getElementById('send');
    const roomInfoEl = document.getElementById('roomInfo');
    const userCountEl = document.getElementById('userCount');

    let ws = null;
    let currentRoom = '';
    let currentUsername = '';

    function log(line, cls = "") {
      const div = document.createElement('div');
      div.textContent = line;
      if (cls) div.className = cls;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateUserCount(count) {
      userCountEl.textContent = count;
    }

    btnConnect.onclick = () => {
      const room = roomEl.value.trim() || "general";
      const username = userEl.value.trim() || "anon";
      const password = passwordEl.value.trim() || null;
      
      currentRoom = room;
      currentUsername = username;

      ws = new WebSocket(`ws://localhost:8000/ws/${encodeURIComponent(room)}/${encodeURIComponent(username)}`);

      ws.onopen = () => {
        log(`Bağlantı kuruluyor...`, "system");
        
        ws.send(JSON.stringify({
          password: password
        }));
      };

      ws.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          
          switch(data.type) {
            case 'connected':
              log(data.message, "system");
              btnConnect.disabled = true;
              btnDisconnect.disabled = false;
              msgEl.disabled = false;
              btnSend.disabled = false;
              roomInfoEl.style.display = 'block';
              msgEl.focus();
              break;
              
            case 'message':
              log(data.content);
              break;
              
            case 'error':
              log(data.message, "error");
              ws.close();
              break;
              
            case 'room_closed':
              log(data.message, "error");
              btnConnect.disabled = false;
              btnDisconnect.disabled = true;
              msgEl.disabled = true;
              btnSend.disabled = true;
              roomInfoEl.style.display = 'none';
              break;
              
            default:
              log(e.data);
          }
        } catch (err) {
          log(e.data);
        }
      };

      ws.onclose = () => {
        log("Bağlantı koptu!", "system");
        btnConnect.disabled = false;
        btnDisconnect.disabled = true;
        msgEl.disabled = true;
        btnSend.disabled = true;
        roomInfoEl.style.display = 'none';
      };

      ws.onerror = (e) => log("Hata: " + (e.message || e.type), "error");
    };

    btnDisconnect.onclick = () => {
      if (ws) ws.close();
    };

    btnSend.onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      const text = msgEl.value.trim();
      if (!text) return;
      
      ws.send(JSON.stringify({
        message: text
      }));
      
      log(`(ben) ${text}`, "me");
      msgEl.value = "";
      msgEl.focus();
    };

    msgEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') btnSend.click();
    });
  </script>
</body>
</html>
