
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Room</title>
  <style>
    body { 
      font-family: system-ui, sans-serif; 
      margin: 20px; 
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    #log { 
      border: 1px solid #ddd; 
      height: 300px; 
      width: 100%; 
      overflow-y: auto; 
      padding: 10px; 
      margin: 10px 0;
      border-radius: 4px;
    }
    #log .me { font-weight: 600; color: #007bff; }
    #log .error { color: red; }
    #log .system { color: #666; font-style: italic; }
    .row { 
      display: flex; 
      gap: 10px; 
      margin: 10px 0; 
      flex-wrap: wrap; 
    }
    input, button { 
      padding: 8px 12px; 
      font-size: 14px; 
      border-radius: 4px; 
      border: 1px solid #ddd; 
    }
    input:focus, button:focus { 
      outline: none; 
      border-color: #007bff; 
    }
    button { 
      background: #007bff; 
      color: white; 
      cursor: pointer; 
      border: none;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    h1 { color: #007bff; text-align: center; }
    .room-info { 
      background: #f8f9fa; 
      padding: 10px; 
      border-radius: 4px; 
      margin: 10px 0;
      border: 1px solid #e9ecef;
    }
  </style>
</head>
<body>

  <h1>Chat Room</h1>
  
  <div class="row">
    <input id="room" placeholder="Oda adı" />
    <input id="username" placeholder="Kullanıcı adı" />
    <input id="password" type="password" placeholder="Şifre" />
    <button id="connect">Bağlan</button>
    <button id="disconnect" disabled>Çık</button>
  </div>

  <div class="room-info" id="roomInfo" style="display: none;">
    <strong>Oda:</strong> <span id="roomName"></span> | <span id="userCount">0</span> kişi online
  </div>

  <div id="log"></div>

  <div class="row">
    <input id="msg" placeholder="Mesaj yaz..." style="flex: 1;" disabled />
    <button id="send" disabled>Gönder</button>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const roomEl = document.getElementById('room');
    const userEl = document.getElementById('username');
    const passwordEl = document.getElementById('password');
    const msgEl = document.getElementById('msg');
    const btnConnect = document.getElementById('connect');
    const btnDisconnect = document.getElementById('disconnect');
    const btnSend = document.getElementById('send');
    const roomInfoEl = document.getElementById('roomInfo');
    const roomNameEl = document.getElementById('roomName');
    const userCountEl = document.getElementById('userCount');

    let ws = null;
    let currentRoom = '';
    let currentUsername = '';

    function log(line, cls = "") {
      const div = document.createElement('div');
      div.textContent = line;
      if (cls) div.className = cls;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    btnConnect.onclick = () => {
      const room = roomEl.value.trim() || "genel";
      const username = userEl.value.trim() || "anon";
      const password = passwordEl.value.trim() || null;
      
      currentRoom = room;
      currentUsername = username;

      ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws/${encodeURIComponent(room)}/${encodeURIComponent(username)}`);

      ws.onopen = () => {
        log(`Bağlantı kuruluyor...`, "system");
        
        ws.send(JSON.stringify({
          password: password
        }));
      };

      ws.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          
          switch(data.type) {
            case 'connected':
              log(data.content, "system");
              btnConnect.disabled = true;
              btnDisconnect.disabled = false;
              msgEl.disabled = false;
              btnSend.disabled = false;
              roomInfoEl.style.display = 'block';
              roomNameEl.textContent = room;
              msgEl.focus();
              break;
              
            case 'message':
              log(data.content);
              break;
              
            case 'error':
              log(data.content, "error");
              ws.close();
              break;
              
            case 'room_closed':
              log(data.content, "error");
              btnConnect.disabled = false;
              btnDisconnect.disabled = true;
              msgEl.disabled = true;
              btnSend.disabled = true;
              roomInfoEl.style.display = 'none';
              break;
              
            default:
              log(e.data);
          }
        } catch (err) {
          log(e.data);
        }
      };

      ws.onclose = () => {
        log("Bağlantı koptu!", "system");
        btnConnect.disabled = false;
        btnDisconnect.disabled = true;
        msgEl.disabled = true;
        btnSend.disabled = true;
        roomInfoEl.style.display = 'none';
      };

      ws.onerror = (e) => log("Hata: " + (e.message || e.type), "error");
    };

    btnDisconnect.onclick = () => {
      if (ws) ws.close();
    };

    btnSend.onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      const text = msgEl.value.trim();
      if (!text) return;
      
      ws.send(JSON.stringify({
        message: text
      }));
      
      log(`(ben) ${text}`, "me");
      msgEl.value = "";
      msgEl.focus();
    };

    msgEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') btnSend.click();
    });
  </script>
</body>
</html>
